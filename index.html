<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <link rel="alternate" type="application/atom+xml" title="Srikanth Sastry" href="/feed.xml">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Srikanth Sastry &middot; A Techie in Boston
    
  </title>

  
  <link rel="canonical" href="//srikanth.sastry.name/">
  

  <link rel="stylesheet" href="//srikanth.sastry.name/public/css/poole.css">
  <link rel="stylesheet" href="//srikanth.sastry.name/public/css/syntax.css">
  <link rel="stylesheet" href="//srikanth.sastry.name/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="//srikanth.sastry.name/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="//srikanth.sastry.name/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="//srikanth.sastry.name/atom.xml">

  
</head>


  <body class="sidebar-overlay theme-base-08">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A personal website</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item active" href="//srikanth.sastry.name/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="//srikanth.sastry.name/about/">About</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="//srikanth.sastry.name/archives/">Archives</a>
        
      
    
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="//srikanth.sastry.name/publications/">Publications</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="//srikanth.sastry.name/touchstone-radio-episodes/">Touchstone Radio Episodes</a>
        
      
    
    <!-- <a class="sidebar-nav-item" href="/archive/v1.1.0.zip">Download</a>
    <a class="sidebar-nav-item" href="">GitHub project</a>
    <span class="sidebar-nav-item">Currently v1.1.0</span> -->
  </nav>
  <div class="sidebar-item">
  <p>
  <a class="navbar-item" href="/feed.xml" target="_blank">Feed</a>
  </p>
  </div>
  <div class="sidebar-item">
    <p>
      &copy; 2025. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Srikanth Sastry</a>
            <small>A Techie in Boston</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="//srikanth.sastry.name/reduce-cyclomatic-complexity/">
        Cyclomatic Complexity: How Low Can You Go?
      </a>
    </h1>

    <span class="post-date">17 Jun 2025</span>

    <p><img src="/images/cpu-in-maze-pixel-art.png" alt="" /></p>
<h2 id="what-even-is-cyclomatic-complexity">What even <em>is</em> Cyclomatic Complexity?</h2>
<p>Ever spend 20 minutes trying to figure out why your bug fix or feature code isn‚Äôt triggering or being executed ‚Äî only to realize you missed a buried branch in someone‚Äôs 10-path function? That‚Äôs <a href="https://en.wikipedia.org/wiki/Cyclomatic_complexity">Cyclomatic Complexity</a> in action. Intuitively, you can think of Cyclomatic Complexity as the number of possible paths a single execution of a function can take.</p>

<p>For example, <code class="language-plaintext highlighter-rouge">a = b + c</code> has a cyclomatic complexity of one, and <code class="language-plaintext highlighter-rouge">a = b + c if foo else d + e</code> has a cyclomatic complexity of two: one path is when <code class="language-plaintext highlighter-rouge">foo</code> is <code class="language-plaintext highlighter-rouge">True</code> and the effective logic is <code class="language-plaintext highlighter-rouge">a = b + c</code>, and the other path is when <code class="language-plaintext highlighter-rouge">foo</code> is <code class="language-plaintext highlighter-rouge">False</code> and the effective logic is <code class="language-plaintext highlighter-rouge">a = d + e</code>.</p>

<h2 id="aint-got-no-time-heres-the-goods">Ain‚Äôt got no time? Here‚Äôs the goods.</h2>

<p>If you take just one thing away from this note, then let it be this.</p>

<blockquote>
  <p><strong>Strive to reduce the Cyclomatic Complexity of your code; your team and your future self will thank you!</strong></p>
</blockquote>

<h2 id="time-to-hit-the-brain-gym-bro">Time to hit the brain gym, bro</h2>
<p>As an exercise, I will let you figure out the cyclomatic complexity of the following piece of code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">env_val</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">...</span><span class="sh">'</span><span class="p">)</span>
<span class="n">switcher_val</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">if</span> <span class="n">env_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">jk_val</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">env_val</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">yes</span><span class="sh">"</span><span class="p">]:</span>
        <span class="n">env_val</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">env_val</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">env_val</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">switch_name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/switch/name/from/config</span><span class="sh">"</span>
    <span class="n">switcher_val</span> <span class="o">=</span> <span class="n">switcher</span><span class="p">.</span><span class="nf">check</span><span class="p">(</span><span class="n">switch_name</span><span class="p">,</span> <span class="n">switchval</span><span class="o">=</span><span class="n">region</span><span class="p">)</span>
<span class="k">if</span> <span class="n">env_val</span> <span class="ow">or</span> <span class="n">switcher_val</span><span class="p">:</span>
    <span class="nf">apply_some_config</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</code></pre></div></div>

<p>I‚Äôll wait‚Ä¶ (Spoiler: It‚Äôs not pretty.)</p>

<p>Give up? Turns out, it is <code class="language-plaintext highlighter-rouge">4</code>: three if-checks contribute to three branching points, and the cyclomatic complexity is one more than that; <em>ergo</em> <code class="language-plaintext highlighter-rouge">4</code>.</p>

<p>Next, by spending no more than 60 seconds looking this code, can you tell me what exactly it is doing? BTW, this is real production code that I ran across when debugging some issue, and it took me a long while to make sure I knew exactly when and how the config is applied. It wasn‚Äôt obvious at all. If you can grok this in 60 seconds, take a bow!</p>

<h2 id="reeling-yet">Reeling yet?</h2>

<p>Anyway, making sense of functions with high cyclomatic complexity is annoying. It‚Äôs notoriously difficult to write tests with good coverage for these functions, and in general, they tend to be bug factories.</p>

<p>And yet ‚Äî somehow ‚Äî a lot of senior software engineers don‚Äôt seem to grok this. I keep seeing deeply nested <code class="language-plaintext highlighter-rouge">if-else</code> blocks, sometimes inside loops with <code class="language-plaintext highlighter-rouge">break</code>s and <code class="language-plaintext highlighter-rouge">continue</code>s, and it doesn‚Äôt seem to bother anyone! It‚Äôs like we‚Äôve collectively normalized this cognitive overhead.</p>

<p>Why?! Why are we putting up with this crap? It‚Äôd never fly in an interview.</p>

<h2 id="yo-lets-fix-it-up">Yo, let‚Äôs fix it up!</h2>
<p>Coming back to the above example, the confusion and ugliness of this code really got to me. It got so bad I considered dusting off a Karnaugh map. After some much needed grokking, I managed to simplify it down to a cyclomatic complexity of <code class="language-plaintext highlighter-rouge">2</code>! :)</p>

<p>In the end, here‚Äôs what that poor little code snippet was trying to do:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Apply config when '...' environment variable is True, else check the switch
</span><span class="n">__ENV_VARIABLE</span> <span class="o">=</span> <span class="sh">'</span><span class="s">...</span><span class="sh">'</span>
<span class="n">__SWITCHER_KEY</span> <span class="o">=</span> <span class="sh">'</span><span class="s">/switch/name/from/config</span><span class="sh">'</span>
<span class="k">def</span> <span class="nf">has_env_override</span><span class="p">():</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">__ENV_VARIABLE</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">val</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">yes</span><span class="sh">"</span><span class="p">}</span>

<span class="nf">if </span><span class="p">(</span>
    <span class="nf">has_env_override</span><span class="p">()</span> <span class="ow">or</span> 
    <span class="n">switcher</span><span class="p">.</span><span class="nf">check</span><span class="p">(</span><span class="n">__SWITCHER_KEY</span><span class="p">,</span> <span class="n">switchval</span><span class="o">=</span><span class="n">region</span><span class="p">)</span>
<span class="p">):</span>
    <span class="nf">apply_some_config</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</code></pre></div></div>

<p>Fewer paths, fewer bugs. Cleaner code. Happier teammates. What‚Äôs not to love?</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="//srikanth.sastry.name/tdd-for-bug-fixes/">
        TDD for Bug Fixes
      </a>
    </h1>

    <span class="post-date">11 Jun 2025</span>

    <p><img src="/images/bug-stabbing-software-engineer-in-the-back.png" alt="" /></p>

<p>I have seen way too many ‚Äòsenior‚Äô engineers get bug fixing wrong. It is common to see an engineer sent a pull request titled ‚Äúbug fix: <something>" and the PR has changes to the functional code that fixes the bug and a correspond test case that shows that the bug is fixed. If that sounds reasonable, THINK AGAIN ‚Äî you‚Äôve walked right into the classic trap!</something></p>

<p><strong>If you are sending PRs for bug fixes with functional code change and an added test case in the same PR/commit, then you are doing it wrong!</strong></p>

<p>The crux of the problem is the following: HOW DO YOU <em>KNOW</em> YOU‚ÄôRE SMASHING THAT BUG? HOW CAN YOU BE SURE YOUR TEST ISN‚ÄôT A DUD?! Your answer better not be <em>VIBE CHECKS</em> or just <em>STARING REALLY HARD</em>! If you are having to deploy your entire service/library and run an end-to-end test to demonstrate correctness, then you are doing too much, and you still haven‚Äôt demonstrated that the unit test actually captures the previously errneous behavior.</p>

<p>There is this shiny little concept called <a href="https://en.wikipedia.org/wiki/Test-driven_development">Test Driven Development (TDD)</a> that is mighty useful here. You can peruse the wikipedia link to figure out what TDD is exactly. This note will show you how to use TDD for bug fixes.</p>

<p>Here are simple steps to fixing bugs using TDD:</p>

<ol>
  <li>
    <p>üïµÔ∏è Discover the bug. BAM! There it is! Your nemesis!</p>
  </li>
  <li>
    <p>üß™ Create a PR that creates a new unit test that exposes the unit test. YAWZA!</p>
  </li>
  <li>
    <p>üîß Create a second PR on top the first PR that makes the functional code change and changes the expectation on the unit test accordingly. That should squash the bug! KAPOW!</p>
  </li>
  <li>
    <p>üí∞ Justice is served! PROFIT!</p>
  </li>
</ol>

<p><img src="/images/tdd-bug-lifecycle.png" alt="" /></p>

<p>Still not sure? Let‚Äôs demonstrate this with an example. Say, there is a bug that you discovered and know how to fix it.</p>

<p>First, you create a PR that demonstrates the bug by invoking your SUT with the offending input, and sets the expected value to be <em>incorrect</em> so that the test case actually <em>passes</em> with this incorrect value; thus demonstrating the bug.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TestSUT</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="bp">...</span>
    <span class="k">def</span> <span class="nf">test_bug_b12345</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sh">'''</span><span class="s">
        Test to expose bug b12345
        </span><span class="sh">'''</span>
        <span class="c1"># Arrange
</span>        <span class="n">sut</span> <span class="o">=</span> <span class="nc">SUT</span><span class="p">(...)</span>
        
        <span class="c1"># Act
</span>        <span class="n">actual</span> <span class="o">=</span> <span class="n">sut</span><span class="p">.</span><span class="nf">test_method</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">bad-input</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># Assert
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">assertEqual</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="sh">"</span><span class="s">bad buggy output</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># The assertion above demonstartes the bug b12345
</span>        <span class="c1"># The right expected value should be "correct output".
</span>        <span class="c1"># self.assertEqual(actual, "correct output")
</span>        
</code></pre></div></div>

<p>You can send that PR out for review and merge it in. Now you have a solid proof that you have found a bug, and reproduced it.</p>

<p>Next, you have a new PR that fixes that bug. If you bug fix is correct, then the test <code class="language-plaintext highlighter-rouge">test_bug_b12345</code> should not start failing. The output of <code class="language-plaintext highlighter-rouge">sut.test_method(input="bad-input")</code> should be <code class="language-plaintext highlighter-rouge">"correct output"</code> and not <code class="language-plaintext highlighter-rouge">"bad buggy output"</code>. So, you now modify the unit test <code class="language-plaintext highlighter-rouge">test_bug_b12345</code> in that same PR that looks as follows:</p>
<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    def test_bug_b12345(self) -&gt; None:
        '''
        Test to expose bug b12345
        '''
        # Arrange
        sut = SUT(...)
        
        # Act
        actual = sut.test_method(input="bad-input")
<span class="err">
</span>        # Assert
<span class="gd">-       self.assertEqual(actual, "bad buggy output")
-       # The assertion above demonstartes the bug b12345
-       # The right expected value should be "correct output".
-       # self.assertEqual(actual, "correct output")
</span><span class="gi">+       self.assertEqual(actual, "correct output")
</span></code></pre></div></div>

<p>Now your test should pass. This second PR is conclusive proof that your diff now fixes the bug! So, merge it in. Deploy with confidence. <strong>BOOM ‚Äî PROFIT!</strong></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="//srikanth.sastry.name/sync-your-alerts-to-your-sev-criteria/">
        Let Sleeping Engineers Lie: Why Your Alerts Should Match Your SEVs
      </a>
    </h1>

    <span class="post-date">07 Jun 2025</span>

    <p><img src="/images/sleepy-engineer-cursing-laptop.png" alt="" />
At work, I had a customer team that aspired to be <em>‚Äúcustomer first.‚Äù</em> To them, that meant fixing issues <em>before</em> they became SEVs. That was all and good, except that the way they went about it was to fire alerts well <em>before</em> their SLOs were close to being breached. Of course, I knew nothing about it until I was the receiving end of their ‚Äòaspiration‚Äô.</p>

<p>It‚Äôs 4 AM, and I am in deep sleep. Suddenly, my phone, overriding all silencing setting starts ringing like there is no tomorrow. Naturally, I was being paged. I wake up bleary eyed, acknowledge the page, and join the team channel. Helpfully, the customer team oncall has message for me: <strong>‚ÄúYour service has a latency spike. Please look into it.‚Äù</strong></p>

<p>I drag myself to a laptop, check the graphs, and yes ‚Äî there <em>was</em> a p99 latency spike, it lasted about half hour, and is already waning. Our SLOs were fine; our latency SLOs at these latency levels don‚Äôt breach for another 30 minutes. I double-checked <em>their</em> SEV criteria, and they are also still green! So why the 4 AM fire drill?</p>

<p>Turns out, they‚Äôd set up their alerts to go off when their p99 latency went above the normal limits for 30 minutes, but their SLO wouldn‚Äôt be breached until the elevated p99 persisted for 60 minutes. A twitcy alert if you ask me!</p>

<p>Their on-call had no idea what to do with the alert, saw my service mentioned, and did the classic move:</p>
<blockquote>
  <p><em>‚ÄúWhen in doubt, escalate!‚Äù</em></p>
</blockquote>

<p>So now <em>I‚Äôm</em> awake, trying to make sense of a 30-minute p99 latency increase that is fixing itself. I asked:</p>

<blockquote>
  <p><strong>‚ÄúWhere‚Äôs the SEV‚Äô?</strong></p>
</blockquote>

<p>I imagine the scene something like this.
<img src="/images/where-sev-where-impact.jpg" alt="" /></p>

<p>Silence. Five minutes later, ‚ÄúHere is the SEV number‚Ä¶‚Äù The SEV was created two minutes ago. Facepalm!</p>

<p>Here‚Äôs what actually happened:</p>
<ul>
  <li>The latency spike lasted about 30 minutes.</li>
  <li>The system auto-healed.</li>
  <li>The affected service was user-facing, but this was deep in the off-hours.</li>
  <li>Total estimated user impact: somewhere between <em>‚Äúnegligible‚Äù</em> and <em>‚Äúnone.‚Äù</em></li>
</ul>

<p>We could‚Äôve all just slept through it and looked at it with fresh eyes in the morning. Instead, two engineers got pulled into zombie mode to stare at graphs that improved all by themselves. It was like debugging a ghost.</p>

<h3 id="moral-of-the-story">Moral of the story:</h3>
<p>If your alert is going to wake someone up at 4 AM, it better be for something that <em>actually</em> matters. If there‚Äôs no SEV, no SLO breach, and no clear user impact ‚Äî maybe let sleeping engineers lie.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="//srikanth.sastry.name/law-of-demeter-and-unit-tests/">
        The Law of Demeter and unit tests
      </a>
    </h1>

    <span class="post-date">22 Jul 2022</span>

    <p><img src="/images/demeter-sketch-bw.jpg" alt="" />
The <a href="https://en.wikipedia.org/wiki/Law_of_Demeter">Law of Demeter</a> essentially says that each unit should only talk to its ‚Äòimmediate friends‚Äô or ‚Äòimmediate dependencies‚Äô, and in spirit, it is pointing to the principle that each unit only have the information it needs to meet its purpose. In that spirit, the Law of Demeter takes two forms that are relevant to making your code more testable: (1) object chains, and (2) fat parameters.</p>

<h2 id="object-chains">Object Chains</h2>

<p>This is the more classic violation of the Law of Demeter<sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>. This happens when a class <code class="language-plaintext highlighter-rouge">C</code> has a dependency <code class="language-plaintext highlighter-rouge">D</code>, and <code class="language-plaintext highlighter-rouge">D</code> has method <code class="language-plaintext highlighter-rouge">m</code> that returns an instance of another class <code class="language-plaintext highlighter-rouge">A</code>. The violation happens when <code class="language-plaintext highlighter-rouge">C</code> accesses <code class="language-plaintext highlighter-rouge">A</code> and calls a method in <code class="language-plaintext highlighter-rouge">A</code>. Note that only <code class="language-plaintext highlighter-rouge">D</code> is the ‚Äòimmediate‚Äô collaborator/dependency of <code class="language-plaintext highlighter-rouge">C</code>, and not <code class="language-plaintext highlighter-rouge">A</code>. The Law of Demeter says that <code class="language-plaintext highlighter-rouge">C</code> should not be accessing the method in <code class="language-plaintext highlighter-rouge">A</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># A violation of the Law of Demeter looks as follows.
## Example 1:
</span><span class="n">c</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="nf">m</span><span class="p">().</span><span class="nf">methodInA</span><span class="p">()</span>

<span class="c1">## Example 2:
</span><span class="n">d</span><span class="p">:</span> <span class="n">D</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">d</span>
<span class="n">a</span><span class="p">:</span> <span class="n">A</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="nf">m</span><span class="p">()</span>
<span class="n">a</span><span class="p">.</span><span class="nf">methodInA</span><span class="p">()</span>
</code></pre></div></div>

<p>What is the problem with violating the Law of Demeter?  Consider the following production code:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UpdateKVStore</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">KVStoreClient</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
        
    <span class="k">def</span> <span class="nf">update_value</span><span class="p">(</span><span class="n">new_content</span><span class="p">:</span> <span class="n">Content</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Status</span><span class="p">:</span>
        <span class="n">transaction</span><span class="p">:</span> <span class="n">KVStoreClient</span><span class="p">.</span><span class="n">Transaction</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="nf">new_transaction</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">transaction</span><span class="p">.</span><span class="nf">get_content</span><span class="p">()</span> <span class="o">==</span> <span class="n">new_content</span><span class="p">:</span>
            <span class="c1"># Nothing to update
</span>            <span class="n">transaction</span><span class="p">.</span><span class="nf">end</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Status</span><span class="p">.</span><span class="n">SUCCESS_UNCHANGED</span>
        <span class="n">mutation_request</span><span class="p">:</span> <span class="n">KVStoreClient</span><span class="p">.</span><span class="n">MutationRequest</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">transaction</span><span class="p">.</span><span class="nf">mutation_request</span><span class="p">().</span><span class="nf">set_content</span><span class="p">(</span><span class="n">new_content</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">mutation</span> <span class="o">=</span> <span class="n">mutation_request</span><span class="p">.</span><span class="nf">prepare</span><span class="p">()</span>
        <span class="n">status</span><span class="p">:</span> <span class="n">KVStoreClient</span><span class="p">.</span><span class="n">Mutation</span> <span class="o">=</span> <span class="n">mutation</span><span class="p">.</span><span class="nf">land</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">status</span>
</code></pre></div></div>

<p>Now how would you unit test this? The test doubles for testing this code will look something like this</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mock_client</span> <span class="o">=</span> <span class="nc">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">KVStoreClient</span><span class="p">)</span>
<span class="n">mock_transaction</span> <span class="o">=</span> <span class="nc">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">KVStoreClient</span><span class="p">.</span><span class="n">Transaction</span><span class="p">)</span>
<span class="n">mock_mutation_request</span> <span class="o">=</span> <span class="nc">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">KVStoreClient</span><span class="p">.</span><span class="n">MutationRequest</span><span class="p">)</span>
<span class="n">mock_mutation</span> <span class="o">=</span> <span class="nc">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">KVStoreClient</span><span class="p">.</span><span class="n">Mutation</span><span class="p">)</span>

<span class="n">mock_client</span><span class="p">.</span><span class="n">new_transaction</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_transaction</span>
<span class="n">mock_transaction</span><span class="p">.</span><span class="n">mutation_request</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_mutation_request</span>
<span class="n">mock_mutation_request</span><span class="p">.</span><span class="n">prepare</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_mutation</span>
</code></pre></div></div>

<p>Now you can see how much the class <code class="language-plaintext highlighter-rouge">UpdateKVStore</code> and its unit tests need to know about the internals of the <code class="language-plaintext highlighter-rouge">KVStoreClient</code>. Any changes to how the <code class="language-plaintext highlighter-rouge">KVStoreClient</code> implements the transaction will cascade into test failures on all its clients! That‚Äôs a recipe for a <a href="https://srikanth.sastry.name/unit-test-attributes-and-their-trade-offs/">low accuracy</a> test suite.</p>

<p>There are a few ways to address this. Instead, if <code class="language-plaintext highlighter-rouge">KVStoreClient</code> could be recast as a <code class="language-plaintext highlighter-rouge">Transaction</code> factory, and then encapsulate all operations associated with the transactions within the <code class="language-plaintext highlighter-rouge">Transaction</code> class, then <code class="language-plaintext highlighter-rouge">UpdateKVStore</code> can be modified as follows:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UpdateKVStore</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">KVStoreClient</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>  <span class="c1"># Now a Factory class for Transaction.
</span>        
    <span class="k">def</span> <span class="nf">update_value</span><span class="p">(</span><span class="n">new_content</span><span class="p">:</span> <span class="n">Content</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Status</span><span class="p">:</span>
        <span class="n">transaction</span><span class="p">:</span> <span class="n">KVStoreClient</span><span class="p">.</span><span class="n">Transaction</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="nf">new_transaction</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">transaction</span><span class="p">.</span><span class="nf">get_content</span><span class="p">()</span> <span class="o">==</span> <span class="n">new_content</span><span class="p">:</span>
            <span class="c1"># Nothing to update
</span>            <span class="n">transaction</span><span class="p">.</span><span class="nf">end</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Status</span><span class="p">.</span><span class="n">SUCCESS_UNCHANGED</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="nf">update_and_land</span><span class="p">(</span><span class="n">new_content</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">status</span>
</code></pre></div></div>

<p>When testing the new <code class="language-plaintext highlighter-rouge">UpdateKVStore</code>, you only need to replace the <code class="language-plaintext highlighter-rouge">KVStoreClient</code> and the <code class="language-plaintext highlighter-rouge">Transaction</code>, both of which are (explicit or implicit) direct dependencies, with test doubles. This makes the code much easier and straightforward to test.</p>

<h2 id="fat-parameters">Fat Parameters</h2>

<p>While the anti-pattern of ‚Äòfat parameters‚Äô does follow directly from the Law of Demeter, it does follow from the spirit of passing in only the information that the class needs to perform its function. So, what are fat parameters? They are data objects that as passed in as an argument to a class, and they contain more information than what is needed by the class.</p>

<p>For instance, say you have a class <code class="language-plaintext highlighter-rouge">EmailDispatcher</code> whose method <code class="language-plaintext highlighter-rouge">setRecipient</code> only needs a customer name and email address. The method signature for <code class="language-plaintext highlighter-rouge">setRecipient</code> should only require the name and email, and not the entire <code class="language-plaintext highlighter-rouge">Customer</code> object that contains a whole lot more.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Customer</span><span class="p">:</span>
    <span class="p">...</span> <span class="c1"># data class members.
</span>    <span class="k">def</span> <span class="nf">getFullName</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="bp">...</span>
    <span class="k">def</span> <span class="nf">getEmail</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="bp">...</span>
    <span class="k">def</span> <span class="nf">getPhysicalAddress</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="bp">...</span>
    <span class="k">def</span> <span class="nf">getPostalCode</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="bp">...</span>
    <span class="k">def</span> <span class="nf">getCountry</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="bp">...</span>
    <span class="k">def</span> <span class="nf">getState</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="bp">...</span>
    <span class="k">def</span> <span class="nf">getCustomerId</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="bp">...</span>
    <span class="c1"># and so on.
</span>    
 <span class="k">class</span> <span class="nc">EmailDispatcher</span><span class="p">:</span>
     <span class="bp">...</span>
     <span class="k">def</span> <span class="nf">setRecipient</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
         <span class="bp">...</span>
     <span class="k">def</span> <span class="nf">setRecipientWithFatParameter</span><span class="p">(</span><span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">):</span>
         <span class="bp">...</span>
     <span class="k">def</span> <span class="nf">sendMessage</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
         <span class="bp">...</span>
</code></pre></div></div>

<p>In the pseudocode above, the class <code class="language-plaintext highlighter-rouge">EmailDispatcher</code> has two methods <code class="language-plaintext highlighter-rouge">setRecipient</code> and <code class="language-plaintext highlighter-rouge">setRecipientWithFatParameter</code>. The former uses only the information it needs, and the latter passed in the entire <code class="language-plaintext highlighter-rouge">Customer</code> object as a fat parameter.</p>

<p>The convenience of passing in the entire <code class="language-plaintext highlighter-rouge">Customer</code> object is straightforward. It allows gives you a simple method signature. It makes it easier for the method to evolve to use richer information about the customer without needing to change its API contract. It allows you to define a common <code class="language-plaintext highlighter-rouge">Dispatcher</code> interface with multiple <code class="language-plaintext highlighter-rouge">Dispatcher</code>s that use different properties of the <code class="language-plaintext highlighter-rouge">Customer</code> class.</p>

<p>However, when it comes to unit testing, such fat parameters present a problem. Consider how you would test the <code class="language-plaintext highlighter-rouge">EmailDispatcher</code>‚Äôs <code class="language-plaintext highlighter-rouge">setRecipientWithFatParameter</code> method. The tests will need to create fake <code class="language-plaintext highlighter-rouge">Customer</code> objects. So, your fake <code class="language-plaintext highlighter-rouge">Customers</code> might look like this:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fakeCustomer</span> <span class="o">=</span> <span class="nc">Customer</span><span class="p">(</span>
    <span class="n">first_name</span><span class="o">=</span><span class="sh">"</span><span class="s">bob</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">last_name</span><span class="o">=</span><span class="sh">"</span><span class="s">marley</span><span class="sh">"</span><span class="p">,</span> 
    <span class="n">email</span><span class="o">=</span><span class="sh">"</span><span class="s">bob@doobie.com</span><span class="sh">"</span><span class="p">,</span> 
    <span class="n">address</span><span class="o">=</span><span class="nc">Address</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">420 High St.</span><span class="sh">"</span><span class="p">,</span> 
      <span class="sh">""</span><span class="p">,</span> 
      <span class="sh">"</span><span class="s">Mary Jane</span><span class="sh">"</span><span class="p">,</span> 
      <span class="sh">"</span><span class="s">Ganga Nation</span><span class="sh">"</span><span class="p">,</span> 
      <span class="sh">"</span><span class="s">7232</span><span class="sh">"</span>
    <span class="p">),</span> 
    <span class="nb">id</span><span class="o">=</span><span class="mi">12345</span><span class="p">,</span> 
    <span class="n">postal_code</span><span class="o">=</span><span class="sh">"</span><span class="s">7232</span><span class="sh">"</span><span class="p">,</span> 
    <span class="bp">...</span>
<span class="p">)</span>
</code></pre></div></div>

<p>When someone reads this unit test, do they know what is relevant here? Does it matter that the second parameter of <code class="language-plaintext highlighter-rouge">address</code> is empty string? Should the last parameter of <code class="language-plaintext highlighter-rouge">address</code> match the value of <code class="language-plaintext highlighter-rouge">postal_code</code>? While we might be able to guess it in this case, it gets more confusing in cases where the fat parameter is encapsulating a much more complicated entity, such as a database table.</p>

<p>When refactoring or making changes to the <code class="language-plaintext highlighter-rouge">EmailDispatcher</code>, if the unit test fails, then figuring out why the test failed becomes a non-trivial exercise, and could end up slowing you down a lot more than you expected. All this just leads to high maintenance costs for tests, low readability <sup id="fnref:2"><a href="#fn:2" class="footnote" rel="footnote" role="doc-noteref">2</a></sup>, poor DevX, and limited benefits.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1">
      <p>You can read about it <a href="https://wouterdekort.com/2012/03/27/unit-testing-hell-or-heaven/">here</a>, <a href="https://hermanradtke.com/2010/01/17/unit-testing-and-the-law-of-demeter.html/">here</a>, <a href="https://wiki.c2.com/?LawOfDemeterMakesUnitTestsEasier">here</a>, and <a href="https://testing.googleblog.com/2008/07/breaking-law-of-demeter-is-like-looking.html">here</a>, and really just search for ‚ÄúLaw of Demeter‚Äù on the Internet¬†<a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>For more details on why we should care about readability, see the section on Readability <a href="https://srikanth.sastry.name/dry-unit-tests-are-bad/">here</a>.¬†<a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="//srikanth.sastry.name/privatize-your-classes-for-better-unit-testing/">
        'Privatize' your classes for better unit testing
      </a>
    </h1>

    <span class="post-date">11 Jul 2022</span>

    <p><img src="images/amber-iceberg-under-water.jpg" alt="" />
You service may be massive, but it‚Äôs public API surface is pretty small; it has just a handful of APIs/endpoints. Everything else behind those APIs are ‚Äòprivate‚Äô and ‚Äòimplementation details‚Äô. It is highly advisable to follow this pattern even when designing the implementation of your service, almost like a fractal. This will pay dividends in the quality of your test suite.</p>

<p>For instance, you service implementation should be split into ‚Äòmodules‚Äô where each module has a well defined API through which other modules interact with it. This API boundary has to be strict. Avoid the temptation of breaking this abstraction because your module need this ‚Äòone tiny bit‚Äô of information that is available inside the implementation of another module. You will regret breaking encapsulation, I guarantee it!</p>

<p>If you follow this pattern, you will eventually reach a class that has a public API, has all of its external/shared dependencies shared, and delegates a lot of it‚Äôs business logic and complex computation to multiple ‚Äòprivate‚Äô classes that are practically hermetic and have no external/shared dependencies. At this point, treat all these ‚Äòprivate‚Äô classes as, well, private. That is, DO NOT WRITE UNIT TESTS FOR SUCH CLASSES!</p>

<p>Yes, that statement seems to fly in the face of all things sane about software testing, but it is a sane statement, nonetheless. These private classes should be tested indirectly via unit tests for the public class that they serve/support. This will make your tests a lot more accurate. Let me explain.</p>

<p>Say, you have a public class <code class="language-plaintext highlighter-rouge">CallMe</code> and it uses a private class <code class="language-plaintext highlighter-rouge">HideMe</code>, and furthermore, <code class="language-plaintext highlighter-rouge">HideMe</code> is used only by <code class="language-plaintext highlighter-rouge">CallMe</code>, and the software design enforces this restriction. Assume that both <code class="language-plaintext highlighter-rouge">CallMe</code> and <code class="language-plaintext highlighter-rouge">HideMe</code> have their own unit tests, and the tests do an excellent job. At this point, there is a new requirement that necessitates that we refactor <code class="language-plaintext highlighter-rouge">CallMe</code>‚Äôs implementation, and as part of that refactoring, we need to modify the API contract between <code class="language-plaintext highlighter-rouge">CallMe</code> and <code class="language-plaintext highlighter-rouge">HideMe</code>. Since <code class="language-plaintext highlighter-rouge">HideMe</code>‚Äôs only  caller is <code class="language-plaintext highlighter-rouge">CallMe</code>, it is completely safe to treat this API contract as an implementation detail and modify it as we see fit. Since we are modifying the specification of <code class="language-plaintext highlighter-rouge">HideMe</code>, we have to change the tests for <code class="language-plaintext highlighter-rouge">HideMe</code> as well.</p>

<p>Now, you run the tests, and the tests for <code class="language-plaintext highlighter-rouge">HideMe</code> fail. What information does that give you? Does that mean that there is a bug in <code class="language-plaintext highlighter-rouge">HideMe</code>; or does it mean that we did not modify the tests correctly? You cannot determine this until you either manually inspect <code class="language-plaintext highlighter-rouge">HideMe</code>‚Äôs test code, or until you run the tests for <code class="language-plaintext highlighter-rouge">CallMe</code>. If <code class="language-plaintext highlighter-rouge">CallMe</code>‚Äôs tests fail, then (since this is a refactoring diff) there must be a bug in <code class="language-plaintext highlighter-rouge">HideMe</code> and/or <code class="language-plaintext highlighter-rouge">CallMe</code>, but if the tests don‚Äôt fail, then it must be an issue in <code class="language-plaintext highlighter-rouge">HideMe</code>‚Äôs tests.</p>

<p>Thus, it turns out that the failure in <code class="language-plaintext highlighter-rouge">HideMe</code> tests gives you no additional information compared to failure in <code class="language-plaintext highlighter-rouge">CallMe</code>‚Äôs tests. Thus, tests for <code class="language-plaintext highlighter-rouge">HideMe</code> have zero benefits and a non-zero maintenance cost! In other words, testing <code class="language-plaintext highlighter-rouge">HideMe</code> directly is useless!</p>

<p>By aggressively refactoring your code to push as much of you logic into private classes, you are limiting the API surface of your software that needs direct testing, and simultaneously, ensuring that your tests suite is not too large, has very <a href="/unit-test-attributes-and-their-trade-offs/">high accuracy, with reasonable completeness</a>.</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="//srikanth.sastry.name/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src='/public/js/script.js'></script>
  </body>
</html>
